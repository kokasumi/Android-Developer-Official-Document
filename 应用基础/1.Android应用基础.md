## 1.Android应用基础

目前Android应用可以使用Kotlin，Java和C++语言进行开发。Android SDK在编译工程中将代码连同任何应用中使用到的数据和资源文件一起打包成APK文件，APK文件是一个以`.apk`结尾的Android包，其中包含了应用需要的所有内容，用于安装Android应用。

### 应用安全机制

Android系统提供了一系列的安全机制来保护应用安全：

- Android操作系统是一个多用户的Linux系统，可以把其中的每个应用都看成一个不同的用户。
- 默认情况，系统会给每个应用分配一个唯一的Linux用户ID(该ID只能由系统使用)，系统会给应用中的所有文件设置权限，只有分配了相应ID的应用才能访问。
- 每个进程都有自己的虚拟机(VM)，因此应用代码一般都是相互隔离运行的。
- 默认情况，每个应用都运行在自己的Linux进程中。系统会在应用中的任何应用组件需要执行时启动进程，然后在不再需要该进程或者系统需要为其他应用恢复内存时关闭进程。
- Android系统实现了**最小权限原则**。默认情况下，应用只能访问其工作所需的组件，不能访问系统中未获得权限的部分。

根据Android系统安全机制，默认情况下，系统不允许应用访问其应用范围外的数据或服务。但是在实际情况中，应用可能有访问外部应用数据或者系统服务的需求，就可以根据以下方法实现：

- 两个共享相同Linux用户ID的应用可以相互访问对方的文件。为了节省系统资源，可以让具有相同Linux用户ID的应用在相同的Linux进程运行并共享相同的VM，应用必须使用相同的证书进行签名。
- 应用可以向用户请求访问设备数据或服务的权限，用户必须明确授予请求权限。

### 应用组件

应用组件是Android应用的基本构建模块。Android框架中最基本的四大组件包括：

- **Activity**：为用户提供交互的窗口屏幕。

- **Service**：一种在后台执行长时间操作或者远程操作的组件，不提供用户界面。根据启动方式不同一般可以分为2种不同的Service：

  **启动Service**：会一直保持运行状态，直至执行的操作完成。根据是否Service是否能被用户感知到又可分为**前台Service**和**后台Service**，前台Service一般能够被用户直接感知到，如播放音乐，一般通过一个通知栏来告知用户关于该Service的信息。系统会尽量保证前台Service所在进程一直运行；用户一般都不能直接感知到后台Service的运行，如后台同步数据，因此系统能够更自由的管理其所在进程。

  **绑定Service**：一般用于跨进程服务的情况，比如说系统或者其他应用想要使用Service。绑定Service期间，Service所在进程的生命周期取决于绑定Service的组件所在进程，如A进程中的一个组件绑定了B进程中的Service，在绑定期间，系统会为了A进程一直保留B进程。

- **Broadcast Receiver**：广播接收器允许系统在正常用户流之外将事件发送给应用，注册了广播接收器的应用能够响应系统范围内的广播。广播接收器一般不显示用户界面，也可以创建状态栏通知，在广播发生时通知用户。广播接收器更一般的用途是作为通往其他组件的“入口”，执行极少量的工作。

- **Content Provider**：可用于管理共享应用数据，数据可以使用文件系统、数据库、Web服务器或者其他任何你应用可以访问的持久存储位置。通过Content Provider，其他应用可以查询甚至修改本应用的数据。对于系统来说，Content Provider用于访问由URI定义的数据项，应用可以决定如何将数据映射到URI命名空间，持有相应的URI就可以访问对应数据。
  - 分配的URI不需要保持应用运行，应用退出后可以继续存在。
  - URI提供了一种细粒度的安全模型。比如说可以将应用A中剪贴板上的一张图片映射到URI中，并使用Content Provider进行锁定，其他应用无法自由访问。应用B想要访问该图片时，就只能通过URI来请求*临时URI访问权限*并访问对应数据，应用中的其他地方无法访问到数据。

#### 激活组件

**Android系统设计的一个独特方面是，无论是否是同一个应用中的组件，都可以相互激活**。因为每个应用都运行在相互隔离的进程中，且有限制其他应用访问本应用文件权限限制，就不能直接启动其他应用中的组件。**Android中是通过系统来激活组件的，应用激活Activity、Service和Broadcast Receiver组件时，向系统发送一条消息并使用Intent传递组件信息，系统根据Intent传递的信息启动相应组件；与其他三大组件不同的是，Content Provider是通过来自ContentResolver的请求激活。**

### Manifest文件

在应用启动组件之前，系统必须读取应用`AndroidManifest.xml`文件来了解应用中使用到的组件信息，应用必须列出所有需要启动的组件，该文件位于项目根目录。Manifest文件中除了列出组件信息外，还有一些其他的功能：

- 声明应用所需的应用权限。
- 声明应用需要的最小API等级。
- 声明应用需要的软件和硬件功能支持。
- 声明应用功能需要链接的API库。
- ...

#### 声明组件

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest ... >
    <application android:icon="@drawable/app_icon.png" ... >
        <activity android:name="com.example.project.ExampleActivity"
                  android:label="@string/example_label" ... >
        </activity>
        ...
    </application>
</manifest>
```

未列在Manifest文件中的Activity，Service和Content Provider对于系统不可见，但是Broadcast Receiver可以在Manifest中声明，也可以通过代码动态注册。

#### 声明组件功能

在使用Intent启动组件时，可以使用显示Intent明确指定需要启动的组件；也可以使用隐式Intent，描述想要启动的组件的类型，系统通过过滤寻找合适的组件，所以想要隐式启动应用组件，就必须让系统了解其过滤条件，可以在应用的Manifest文件中设置组件过滤条件。

```xml
<manifest ... >
    ...
    <application ... >
        <activity android:name="com.example.project.ComposeEmailActivity">
            <intent-filter>
                <action android:name="android.intent.action.SEND" />
                <data android:type="*/*" />
                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>
        </activity>
    </application>
</manifest>
```

#### 声明应用需求

目前市场上Android设备各式各样的，但并不是所有的Android设备都能提供相同的功能。为了防止应用安装在缺乏相应功能支持的设备上，在Manifest文件中明确定义应用需要的软件和硬件功能支持，来确定应用支持的设备类型是很重要的。大多数这类声明设备不会读取，仅供第三方参考，比如Google play过滤用户。

```xml
<manifest ... >
    <uses-feature android:name="android.hardware.camera.any"
                  android:required="true" />
    <uses-sdk android:minSdkVersion="7" android:targetSdkVersion="19" />
    ...
</manifest>
```

### 应用资源

Android应用除了代码之外，还需要与代码分离的应用资源支持。给不同配置的设备提供相应资源文件，可以很容易的进行应用适配。对于项目中的每个资源文件，SDK都会分配其一个唯一整型ID，可以在代码或者XML资源文件中引用。Android支持很多替代资源*限定符*，限定符是一种加入到资源目录名称中，用于指定这些资源适用的设备配置段字符串，如`res/values-fr/`表示法语字符串文件，系统会根据限定符和系统配置自动进行适配。

### 参考文件

该笔记参考自：[Application Fundamentals](https://developer.android.google.cn/guide/components/fundamentals.html)